<div class="calendar-container">
  <!-- Filtros de tipos de clase -->
  <div class="class-filters mb-4" *ngIf="availableClassTypes.length > 0">
    <div class="filter-items">
      <button
        *ngFor="let classType of availableClassTypes"
        type="button"
        class="filter-item"
        [class.active]="isClassTypeVisible(classType.name)"
        (click)="toggleClassTypeFilter(classType.name)">

        <div
          class="color-dot"
          [style.background-color]="classType.color.background"
          [style.border-color]="classType.color.border">
        </div>

        <span class="type-name">{{ getMobileShortName(classType.name) }}</span>

        <span class="filter-toggle">
          {{ isClassTypeVisible(classType.name) ? '✓' : '✗' }}
        </span>
      </button>
    </div>
  </div>

  <!-- Calendario -->
  <div class="calendar-content">
    <full-calendar [options]="calendarOptions"></full-calendar>
  </div>
</div>

<!-- Modal de Reserva -->
<div class="modal fade" 
     [class.show]="showBookingModal" 
     [style.display]="showBookingModal ? 'block' : 'none'" 
     *ngIf="showBookingModal"
     tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      
      <!-- Header del Modal -->
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-calendar-plus me-2"></i>
          {{ selectedSession?.class_type_name || 'Clase' }}
        </h5>
        <button type="button" 
                class="btn-close" 
                (click)="closeBookingModal()"
                [disabled]="loadingModal">
        </button>
      </div>

      <!-- Body del Modal -->
      <div class="modal-body">
        <!-- Loading State -->
        <div *ngIf="loadingModal" class="text-center py-4">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mb-0">Verificando disponibilidad...</p>
        </div>

        <!-- Content cuando no está cargando -->
        <div *ngIf="!loadingModal">
          
          <!-- Información de la clase -->
          <div class="class-details mb-4" *ngIf="selectedSession">
            <div class="card bg-light">
              <div class="card-body">
                <div class="row">
                  <div class="col-6">
                    <strong>Fecha:</strong><br>
                    <span>{{ selectedSession.schedule_date | date:'EEEE, d \'de\' MMMM':'es-ES' }}</span>
                  </div>
                  <div class="col-6">
                    <strong>Hora:</strong><br>
                    <span>{{ selectedSession.schedule_time }}</span>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-6">
                    <strong>Tipo:</strong><br>
                    <span class="badge bg-primary">{{ selectedSession.class_type_name }}</span>
                  </div>
                  <div class="col-6">
                    <strong>Duración:</strong><br>
                    <span>{{ selectedSession.class_type_duration || 50 }} min</span>
                  </div>
                </div>
                <!-- Deadline exacto para cancelar, si aplica -->
                <div class="row mt-2" *ngIf="selectedSession.is_self_booked && selectedSession.self_cancellation_time">
                  <div class="col-12">
                    <strong>Límite para cancelar:</strong><br>
                    <span>
                      {{ selectedSession.self_cancellation_time | date:'EEEE, d \'de\' MMMM, HH:mm':'es-ES' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mensajes de Error -->
          <div *ngIf="modalError" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ modalError }}
          </div>

          <!-- Mensajes de Éxito -->
          <div *ngIf="modalSuccess" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            {{ modalSuccess }}
          </div>

          <!-- Estado: Usuario puede reservar -->
          <div *ngIf="userCanBook && !modalError && !modalSuccess">
            <div class="alert alert-info" role="alert">
              <i class="fas fa-info-circle me-2"></i>
              Puedes reservar esta clase con tu bono disponible.
            </div>
          </div>

          <!-- Estado: Lista de espera (no mostrar en personalizadas ni si ya está reservado) -->
          <div *ngIf="!modalError && !modalSuccess && selectedSession && !selectedSession.is_self_booked && isSelectedSessionFull() && !isSelectedSessionPersonal()">
            
            <!-- Usuario NO está en lista de espera -->
            <div *ngIf="!isInWaitingList">
              <div class="alert alert-warning d-flex align-items-center justify-content-between" role="alert">
                <i class="fas fa-users me-2"></i>
                <span>Esta clase está completa, pero puedes unirte a la lista de espera.</span>
                <button type="button" class="btn btn-sm btn-warning ms-3" (click)="joinWaitingList()">
                  <i class="fas fa-user-plus me-1"></i> Unirme ahora
                </button>
              </div>
              
              <div class="waiting-list-info" *ngIf="waitingListCount > 0">
                <p class="mb-2">
                  <strong>Personas en lista de espera:</strong> 
                  <span class="waiting-list-position">{{ waitingListCount }}</span>
                </p>
                <small class="text-muted">
                  Te notificaremos si se libera un lugar.
                </small>
              </div>
            </div>

            <!-- Usuario SÍ está en lista de espera -->
            <div *ngIf="isInWaitingList">
              <div class="alert alert-info" role="alert">
                <i class="fas fa-clock me-2"></i>
                Ya estás en la lista de espera para esta clase.
              </div>
              
              <div class="waiting-list-info">
                <p class="mb-2">
                  <strong>Tu posición:</strong> 
                  <span class="waiting-list-position">#{{ waitingListPosition }}</span>
                </p>
                <small class="text-muted">
                  Te notificaremos cuando sea tu turno.
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer del Modal -->
      <div class="modal-footer" *ngIf="!loadingModal">
        
        <!-- Botón Cancelar (siempre visible) -->
        <button type="button" 
                class="btn btn-secondary" 
                (click)="closeBookingModal()">
          Cancelar
        </button>

        <!-- Botón Cancelar reserva (si ya está reservado) -->
        <button *ngIf="selectedSession?.is_self_booked && !modalError"
    type="button"
    class="btn btn-danger"
    [disabled]="!canCancelSelectedBooking()"
    (click)="cancelOwnBooking()">
    <i class="fas fa-times me-2"></i>
    Cancelar Reserva
  </button>

        <!-- Aviso de que no se puede cancelar si pasó el tiempo -->
        <div *ngIf="selectedSession?.is_self_booked && !canCancelSelectedBooking() && !modalError" class="text-muted small">
          Ya no se puede cancelar la reserva: han pasado las 12 horas previas al inicio.
        </div>

  <!-- Botón Reservar (solo si puede reservar y no está ya reservado) -->
        <button *ngIf="!selectedSession?.is_self_booked && userCanBook && !modalError"
                type="button" 
                class="btn btn-success"
                (click)="reserveClass()">
          <i class="fas fa-check me-2"></i>
          Confirmar Reserva
        </button>

  <!-- Botón Unirse a Lista de Espera (footer, backup) -->
  <button *ngIf="selectedSession && !selectedSession.is_self_booked && isSelectedSessionFull() && !isInWaitingList && !modalError && !isSelectedSessionPersonal()"
    type="button" 
    class="btn btn-warning"
    (click)="joinWaitingList()">
    <i class="fas fa-clock me-2"></i>
    Unirse a Lista de Espera
  </button>

        <!-- Botón Salir de Lista de Espera -->
        <button *ngIf="isInWaitingList && !modalError && !modalSuccess"
                type="button" 
                class="btn btn-outline-danger"
                (click)="cancelWaitingList()">
          <i class="fas fa-times me-2"></i>
          Salir de Lista de Espera
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showBookingModal"></div>