<!-- toolbar moved inside the calendar wrapper so it shares the same horizontal padding/width -->

<!-- Shared offcanvas for desktop and mobile. On mobile it appears from the right via .offcanvas-end -->
<div [class.modal-backdrop]="desktopFiltersOpen || mobileFiltersOpen" [class.fade]="desktopFiltersOpen || mobileFiltersOpen" [class.show]="desktopFiltersOpen || mobileFiltersOpen" (click)="closeFilters()" [attr.aria-hidden]="!(desktopFiltersOpen || mobileFiltersOpen)"></div>

<div class="offcanvas" [class.offcanvas-start]="!isMobile" [class.offcanvas-end]="isMobile" [class.show]="desktopFiltersOpen || mobileFiltersOpen" tabindex="-1" [attr.aria-hidden]="!(desktopFiltersOpen || mobileFiltersOpen)" role="dialog" aria-modal="true" aria-label="Filtros del calendario">
	<div class="offcanvas-header">
		<h5 class="offcanvas-title">Filtros</h5>
		<button type="button" class="btn-close text-reset" aria-label="Cerrar" (click)="closeFilters()"></button>
	</div>
	<div class="offcanvas-body">

		<!-- Views: Desktop shows Semana/Mes; Mobile shows Día/Semana -->
		<div class="mb-3 d-flex justify-content-between">
			<!-- Mobile: Día / Semana -->
			<div *ngIf="isMobile" class="d-flex justify-content-between w-100">
				<button type="button" class="btn btn-sm d-flex align-items-center gap-2 filters-btn" [class.active]="currentView === 'day'" (click)="setView('day')">Día</button>
				<button type="button" class="btn btn-sm d-flex align-items-center gap-2 filters-btn" [class.active]="currentView === 'week'" (click)="setView('week')">Semana</button>
			</div>
			<!-- Desktop: Semana / Mes -->
			<div *ngIf="!isMobile" class="d-flex justify-content-between w-100">
				<button type="button" class="btn btn-sm d-flex align-items-center gap-2 filters-btn" [class.active]="currentView === 'week'" (click)="setView('week')">Semana</button>
				<button type="button" class="btn btn-sm d-flex align-items-center gap-2 filters-btn" [class.active]="currentView === 'month'" (click)="setView('month')">Mes</button>
			</div>
		</div>

		<hr />

		<!-- Dynamic class type filters loaded from backend -->
		<div class="filter-controls mb-2 d-flex justify-content-between align-items-center">
			<div>Tipos de clase</div>
			<div class="text-muted small">{{ availableClassTypes.length }} encontrados</div>
		</div>
		<div class="filter-items d-flex flex-column gap-2">
			<ng-container *ngIf="typesLoaded; else noTypes">
								<button *ngFor="let t of availableClassTypes" type="button" class="form-check d-flex align-items-center justify-content-between p-2 rounded filter-row" [attr.aria-pressed]="isClassTypeVisible(t.name)" [ngClass]="{'active': isClassTypeVisible(t.name)}" [ngStyle]="{'background-color': isClassTypeVisible(t.name) ? t.color.background : '#fff', 'border': '1px solid ' + (t.color.border || t.color.background || '#e6e6e6'), 'color': getContrastColor(isClassTypeVisible(t.name) ? t.color.background : '#fff')}" (click)="toggleClassTypeFilter(t.name)">
										<div class="d-flex align-items-center gap-2">
												<input class="form-check-input visually-hidden" type="checkbox" [checked]="isClassTypeVisible(t.name)" (change)="toggleClassTypeFilter(t.name)" [id]="'ft-'+t.name" />
												<span class="filter-name">{{ t.name }}</span>
										</div>
								</button>
			</ng-container>
			<ng-template #noTypes>
				<div class="text-muted">Cargando tipos de clase…</div>
			</ng-template>
		</div>

	</div>
</div>

<!-- Calendar -->
<div class="calendar-page p-wrapper">
		<div class="container-fluid px-0">
			<div class="row justify-content-center">
				<div class="col-12">
					<app-calendar-toolbar
						[currentRangeLabel]="currentRangeLabel"
						[currentView]="currentView"
						[isMobile]="isMobile"
						[filtersCollapsed]="desktopFiltersCollapsed"
						(prev)="onPrev()"
						(next)="onNext()"
						(today)="goToday()"
						(changeView)="setView($event)"
						(toggleFilters)="onToolbarToggleFilters()"
					></app-calendar-toolbar>
				</div>
			</div>
		</div>
	<div *ngIf="!typesLoaded" class="calendar-loading d-flex align-items-center justify-content-center" style="min-height:300px;">
		<div class="text-center">
			<div class="spinner-border" role="status" aria-hidden="true"></div>
			<div class="mt-2 text-muted">Cargando calendario…</div>
		</div>
	</div>
	<div *ngIf="typesLoaded">
		<div #calendarContent class="calendar-content">
			<full-calendar #calendar [options]="calendarOptions"></full-calendar>
		</div>
	</div>
</div>

<!-- Mobile uses the same offcanvas as desktop; we toggle position via classes in CSS/host -->

<!-- Booking modal (centered) -->
<div class="booking-modal-backdrop fade" [class.show]="showBookingModal" (click)="closeBookingModal()" [attr.aria-hidden]="!showBookingModal"></div>

<div *ngIf="showBookingModal" class="booking-modal" role="dialog" aria-modal="true" [attr.aria-label]="selectedSession ? ('Detalles de ' + selectedSession.class_type_name) : 'Detalles de la sesión'">
	<div class="booking-modal-dialog">
		<div class="booking-modal-header">
			<h5 class="booking-modal-title">{{ selectedSession ? selectedSession.class_type_name : 'Cargando…' }}</h5>
			<button type="button" class="btn-close text-reset" aria-label="Salir" (click)="closeBookingModal()"></button>
		</div>
		<div class="booking-modal-body">
			<ng-container *ngIf="selectedSession; else loadingBooking">
				<div class="mb-2 text-muted small">{{ formatDateCapitalMonthWithTime(selectedSession.schedule_date + 'T' + (selectedSession.schedule_time || '00:00:00')) }}</div>
				<div class="mb-2">
					<strong>Tipo:</strong> {{ selectedSession.class_type_name }}
				</div>
								<div class="mb-2">
									<strong>Duración:</strong> {{ sessionDuration(selectedSession) }} min
								</div>
				<div class="mb-2 text-sm text-muted" *ngIf="isSelectedSessionPersonal()">Esta es una sesión personalizada.</div>
				<div class="mb-2">
					<span *ngIf="isSelectedSessionFull()">Llena</span>
					<span *ngIf="!isSelectedSessionFull()">Plazas disponibles: {{ availableSpotsForTemplate(selectedSession) ?? '—' }}</span>
				</div>
				<div class="mt-2 text-danger" *ngIf="modalError">{{ modalError }}</div>
				<div class="mt-2 text-success" *ngIf="modalSuccess">{{ modalSuccess }}</div>
			</ng-container>
			<ng-template #loadingBooking>
				<div>Cargando detalles de la sesión…</div>
			</ng-template>
		</div>
			<div class="booking-modal-footer">
				<button type="button" class="btn btn-secondary" (click)="closeBookingModal()">Salir</button>
				<!-- If already booked, show Cancel button; otherwise show Reserve/Waitlist actions -->
				<button *ngIf="selectedSession?.is_self_booked; else notBookedBtns" type="button" [ngClass]="{'btn': true, 'btn-danger': true}" [disabled]="loadingModal || !canCancelSelectedBooking()" (click)="cancelOwnBooking()">
					<span *ngIf="loadingModal" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
					Cancelar
				</button>
				<ng-template #notBookedBtns>
					<!-- If session is full, offer waitlist actions; otherwise show reserve -->
					<button *ngIf="isSelectedSessionFull(); else simpleReserve" type="button" [ngClass]="{'btn': true, 'btn-outline-primary': true}" [disabled]="loadingModal || !userCanBook" (click)="isInWaitingList ? cancelWaitingList() : joinWaitingList()">
						<span *ngIf="loadingModal" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
						<span *ngIf="!isInWaitingList">Añadir Lista de Espera</span>
						<span *ngIf="isInWaitingList">Eliminar Lista de Espera</span>
					</button>
					<ng-template #simpleReserve>
						<button type="button" [ngClass]="{'btn': true, 'btn-success': true}" [disabled]="loadingModal || !userCanBook" (click)="reserveClass()">
							<span *ngIf="loadingModal" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
							Reservar
						</button>
					</ng-template>
				</ng-template>
			</div>
	</div>
</div>

<!-- Shared admin-style toast (global styles in src/styles.css) -->
<div class="toast-container" [class.show]="showToast" aria-live="polite" aria-atomic="true">
	<div class="toast" [class.toast-success]="toastType === 'success'" [class.toast-error]="toastType === 'error'">
		<div class="toast-content"><i class="bi bi-check-circle-fill" aria-hidden="true"></i><div>{{ toastMessage }}</div></div>
		<button class="toast-close" type="button" aria-label="Cerrar" (click)="hideToast()">✕</button>
	</div>
</div>