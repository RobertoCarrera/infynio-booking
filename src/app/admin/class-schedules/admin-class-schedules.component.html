<div class="admin-schedules-container">
  <!-- Header -->
  <div class="schedules-header">
    <h2>Gestión de Sesiones de Clases</h2>
    <div class="header-actions">
      <button type="button" class="btn btn-primary" (click)="openAddModal()">
        <i class="fas fa-plus"></i> Nueva Sesión
      </button>
      <button type="button" class="btn btn-secondary" (click)="openGenerateModal()">
        <i class="fas fa-magic"></i> Generar Sesiones
      </button>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls-section">
    <div class="view-controls">
      <div class="btn-group" role="group">
        <button type="button" 
                class="btn"
                [class.btn-primary]="viewMode === 'calendar'"
                [class.btn-outline-primary]="viewMode !== 'calendar'"
                (click)="changeViewMode('calendar')">
          <i class="fas fa-calendar-day"></i> Vista Diaria
        </button>
        <button type="button" 
                class="btn"
                [class.btn-primary]="viewMode === 'list'"
                [class.btn-outline-primary]="viewMode !== 'list'"
                (click)="changeViewMode('list')">
          <i class="fas fa-list"></i> Vista Lista
        </button>
      </div>
    </div>

    <!-- Date Picker for Calendar View -->
    <div class="date-controls" *ngIf="viewMode === 'calendar'">
      <label for="dateSelect">Fecha:</label>
      <button *ngIf="!isPrevDayDisabled()" type="button" class="btn btn-outline-secondary btn-sm me-2" (click)="changeDay(-1)" title="Día anterior">&#8592;</button>
      <input type="date" 
             id="dateSelect"
             class="form-control d-inline-block w-auto" 
             [(ngModel)]="selectedDate" 
             (change)="onDateChange()">
      <button type="button" class="btn btn-outline-secondary btn-sm ms-2" (click)="changeDay(1)" title="Día siguiente">&#8594;</button>
    </div>
  </div>

  <!-- Messages -->
  <div class="alert alert-success" *ngIf="successMessage">
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="clearMessages()"></button>
  </div>

  <div class="alert alert-danger" *ngIf="error">
    {{ error }}
    <button type="button" class="btn-close" (click)="clearMessages()"></button>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Calendar View -->
  <div class="calendar-view" *ngIf="viewMode === 'calendar'">
    <div class="calendar-date-header">
      <h3>{{ formatDisplayDate(selectedDate) }}</h3>
    </div>
    
    <div class="sessions-for-date">
      <div class="session-card" *ngFor="let session of sessions">
        <div class="session-info">
          <div class="session-time">
            <i class="fas fa-clock"></i>
            {{ formatTime(session.schedule_time) }}
          </div>
          <div class="session-details">
            <h4>{{ getClassTypeName(session.class_type_id) }}</h4>
            <p class="capacity-info">
              <i class="fas fa-users"></i>
              Capacidad: {{ session.capacity }}
            </p>
          </div>
        </div>
        <div class="session-actions">
          <button type="button" 
                  class="btn btn-sm btn-outline-primary" 
                  (click)="openEditModal(session)"
                  title="Editar sesión de clase">
            <i class="fas fa-edit me-1"></i> Editar
          </button>
          <button type="button" 
                  class="btn btn-sm btn-outline-danger" 
                  (click)="deleteSession(session)"
                  title="Eliminar sesión de clase">
            <i class="fas fa-trash me-1"></i> Eliminar
          </button>
        </div>
      </div>
      
      <div class="no-sessions" *ngIf="sessions.length === 0 && !loading">
        <p>No hay sesiones programadas para esta fecha.</p>
        <button type="button" class="btn btn-primary" (click)="openAddModal()">
          Agregar primera sesión
        </button>
      </div>
    </div>
  </div>

  <!-- List View -->
  <div class="list-view" *ngIf="viewMode === 'list'">
    <ng-container *ngFor="let dateGroup of getSessionsByDate() | keyvalue">
      <div class="date-group">
        <h3 class="date-header">{{ formatDisplayDate(dateGroup.key) }}</h3>
        
        <div class="sessions-list">
          <div class="session-item" *ngFor="let session of dateGroup.value">
            <div class="session-time">
              {{ formatTime(session.schedule_time) }}
            </div>
            <div class="session-info">
              <h4>{{ getClassTypeName(session.class_type_id) }}</h4>
              <p class="capacity-info">Capacidad: {{ session.capacity }}</p>
            </div>
            <div class="session-actions">
              <button type="button" 
                      class="btn btn-sm btn-outline-primary" 
                      (click)="openEditModal(session)"
                      title="Editar sesión de clase">
                <i class="fas fa-edit me-1"></i>
                Editar
              </button>
              <button type="button" 
                      class="btn btn-sm btn-outline-danger" 
                      (click)="deleteSession(session)"
                      title="Eliminar sesión de clase">
                <i class="fas fa-trash me-1"></i>
                Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
    
    <div class="no-sessions" *ngIf="sessions.length === 0 && !loading">
      <p>No hay sesiones programadas.</p>
      <button type="button" class="btn btn-primary" (click)="openAddModal()">
        Crear primera sesión
      </button>
    </div>
  </div>
</div>

<!-- Modal: Add/Edit Session -->
<div class="modal fade" [class.show]="showAddModal || showEditModal" [style.display]="showAddModal || showEditModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ editingSession ? 'Editar Sesión' : 'Nueva Sesión' }}
        </h5>
        <button type="button" class="btn-close" (click)="editingSession ? closeEditModal() : closeAddModal()"></button>
      </div>
      
      <form [formGroup]="sessionForm" (ngSubmit)="saveSession()">
        <div class="modal-body">
          <div class="mb-3">
            <label for="classType" class="form-label">Tipo de Clase *</label>
            <select id="classType" class="form-select" formControlName="class_type_id" required>
              <option value="">Selecciona un tipo de clase</option>
              <option *ngFor="let classType of classTypes" [value]="classType.id">
                {{ classType.name }} ({{ classType.duration_minutes }} min)
              </option>
            </select>
          </div>

          <div class="mb-3">
            <label for="scheduleDate" class="form-label">Fecha *</label>
            <input type="date" 
                   id="scheduleDate" 
                   class="form-control" 
                   formControlName="schedule_date" 
                   required>
          </div>

          <div class="mb-3">
            <label for="scheduleTime" class="form-label">Hora *</label>
            <input type="time" 
                   id="scheduleTime" 
                   class="form-control" 
                   formControlName="schedule_time" 
                   required>
          </div>

          <!-- Capacidad se asigna automáticamente según el tipo de clase -->
        </div>
        
        <div class="modal-footer">
          <button type="button" 
                  class="btn btn-secondary" 
                  (click)="editingSession ? closeEditModal() : closeAddModal()">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn btn-primary" 
                  [disabled]="sessionForm.invalid || loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            {{ editingSession ? 'Actualizar' : 'Crear' }} Sesión
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Generate Recurring Sessions -->
<div class="modal fade" [class.show]="showGenerateModal" [style.display]="showGenerateModal ? 'block' : 'none'">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generar Sesiones Recurrentes</h5>
        <button type="button" class="btn-close" (click)="closeGenerateModal()"></button>
      </div>
      
      <form [formGroup]="generateForm" (ngSubmit)="generateRecurringSessions()">
        <div class="modal-body">
          <div class="mb-3">
            <label for="genClassType" class="form-label">Tipo de Clase *</label>
            <select id="genClassType" class="form-select" formControlName="class_type_id" required>
              <option value="">Selecciona un tipo de clase</option>
              <option *ngFor="let classType of classTypes" [value]="classType.id">
                {{ classType.name }} ({{ classType.duration_minutes }} min)
              </option>
            </select>
          </div>

          <div class="mb-3">
            <label for="dayOfWeek" class="form-label">Día de la Semana *</label>
            <select id="dayOfWeek" class="form-select" formControlName="day_of_week" required>
              <option value="">Selecciona un día</option>
              <option *ngFor="let day of daysOfWeek" [value]="day.value">
                {{ day.name }}
              </option>
            </select>
          </div>

          <div class="mb-3">
            <label for="genScheduleTime" class="form-label">Hora *</label>
            <input type="time" 
                   id="genScheduleTime" 
                   class="form-control" 
                   formControlName="schedule_time" 
                   required>
          </div>

          <!-- Capacidad se asigna automáticamente según el tipo de clase -->

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="startDate" class="form-label">Fecha Inicio *</label>
                <input type="date" 
                       id="startDate" 
                       class="form-control" 
                       formControlName="start_date" 
                       required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="endDate" class="form-label">Fecha Fin *</label>
                <input type="date" 
                       id="endDate" 
                       class="form-control" 
                       formControlName="end_date" 
                       required>
              </div>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Se crearán sesiones para el día seleccionado de cada semana entre las fechas especificadas.
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" 
                  class="btn btn-secondary" 
                  (click)="closeGenerateModal()">
            Cancelar
          </button>
          <button type="submit" 
                  class="btn btn-primary" 
                  [disabled]="generateForm.invalid || loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            Generar Sesiones
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" 
     [class.show]="showAddModal || showEditModal || showGenerateModal" 
     *ngIf="showAddModal || showEditModal || showGenerateModal">
</div>
