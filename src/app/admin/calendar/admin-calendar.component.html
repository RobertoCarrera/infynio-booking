<div class="admin-calendar-container admin-calendar-active">
  <!-- Shared filters overlay (desktop offcanvas from left, mobile from right) -->
  <div [class.modal-backdrop]="desktopFiltersOpen || mobileFiltersOpen" [class.fade]="desktopFiltersOpen || mobileFiltersOpen" [class.show]="desktopFiltersOpen || mobileFiltersOpen" (click)="closeFilters()" [attr.aria-hidden]="!(desktopFiltersOpen || mobileFiltersOpen)"></div>

  <div class="offcanvas" [class.offcanvas-start]="!isMobile" [class.offcanvas-end]="isMobile" [class.show]="desktopFiltersOpen || mobileFiltersOpen" tabindex="-1" [attr.aria-hidden]="!(desktopFiltersOpen || mobileFiltersOpen)" role="dialog" aria-modal="true" aria-label="Filtros del calendario (admin)">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Filtros</h5>
      <button type="button" class="btn-close text-reset" aria-label="Cerrar" (click)="closeFilters()"></button>
    </div>
    <div class="offcanvas-body">
      <!-- View toggles -->
      <div class="mb-3 d-flex justify-content-between">
        <div *ngIf="isMobile" class="d-flex justify-content-between w-100">
          <button type="button" class="btn btn-sm d-flex align-items-center gap-2 filters-btn" [class.active]="currentView === 'day'" (click)="setView('day')">Día</button>
          <button type="button" class="btn btn-sm d-flex align-items-center gap-2 filters-btn" [class.active]="currentView === 'week'" (click)="setView('week')">Semana</button>
        </div>
        <div *ngIf="!isMobile" class="d-flex justify-content-between w-100">
          <button type="button" class="btn btn-sm d-flex align-items-center gap-2 filters-btn" [class.active]="currentView === 'week'" (click)="setView('week')">Semana</button>
          <button type="button" class="btn btn-sm d-flex align-items-center gap-2 filters-btn" [class.active]="currentView === 'month'" (click)="setView('month')">Mes</button>
        </div>
      </div>

      <hr />

      <!-- Class type filters (non-personal types) -->
      <div class="filter-controls mb-2 d-flex justify-content-between align-items-center">
        <div>Tipos de clase</div>
        <div class="text-muted small">{{ availableClassTypes.length }} encontrados</div>
      </div>
      <div class="filter-items d-flex flex-column gap-2">
        <ng-container *ngIf="typesLoaded; else noTypes">
          <button *ngFor="let t of availableClassTypes" type="button" class="form-check d-flex align-items-center justify-content-between p-2 rounded filter-row" [attr.aria-pressed]="isClassTypeVisible(t.name)" [ngClass]="{'active': isClassTypeVisible(t.name)}" [ngStyle]="{'background-color': isClassTypeVisible(t.name) ? t.color.background : '#fff', 'border': '1px solid ' + (t.color.border || t.color.background || '#e6e6e6'), 'color': getContrastColor(isClassTypeVisible(t.name) ? t.color.background : '#fff')}" (click)="toggleClassTypeFilter(t.name)">
            <div class="d-flex align-items-center gap-2">
              <input class="form-check-input visually-hidden" type="checkbox" [checked]="isClassTypeVisible(t.name)" (change)="toggleClassTypeFilter(t.name)" [id]="'ft-'+t.name" />
              <span class="filter-name">{{ t.name }}</span>
            </div>
          </button>
        </ng-container>
        <ng-template #noTypes>
          <div class="text-muted">Cargando tipos de clase…</div>
        </ng-template>
      </div>
    </div>
  </div>
  <!-- User calendar toolbar (shared) -->
  <div class="container-fluid px-0">
    <div class="row justify-content-center">
      <div class="col-12">
        <app-calendar-toolbar
          [currentRangeLabel]="currentRangeLabel"
          [currentView]="currentView"
          [isMobile]="isMobile"
          [filtersCollapsed]="false"
          (prev)="onPrev()"
          (next)="onNext()"
          (today)="goToday()"
          (changeView)="setView($event)"
          (toggleFilters)="onToolbarToggleFilters()"
        ></app-calendar-toolbar>
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error }}
    <button type="button" class="btn-close" (click)="clearMessages()"></button>
  </div>

  <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
    <i class="fas fa-check-circle me-2"></i>
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="clearMessages()"></button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="d-flex justify-content-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- Calendar: mantener siempre montado para no perder vista/fecha -->
  <div class="calendar-container">
    <!-- Use the same wrapper class as the user calendar so global styles apply identically -->
    <div class="p-wrapper">
  <full-calendar #calendar [options]="calendarOptions"></full-calendar>
    </div>
  </div>

<!-- Modal para crear/editar sesión -->
<div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" *ngIf="showModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-calendar-plus me-2" *ngIf="!isEditing"></i>
          <i class="fas fa-edit me-2" *ngIf="isEditing"></i>
          {{ isEditing ? 'Editar Sesión' : 'Nueva Sesión' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      
      <form [formGroup]="sessionForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <!-- Session info if editing -->
          <div *ngIf="isEditing && selectedSession" class="alert alert-info mb-3">
            <h6 class="mb-1">Sesión Actual:</h6>
            <p class="mb-0">
              <strong>{{ getClassTypeName(selectedSession.class_type_id) }}</strong><br>
                <small>
                {{ selectedSession.schedule_date }}<br>
                {{ formatTimeForTemplate(selectedSession.schedule_time) | date:'HH:mm' }}
              </small>
            </p>
          </div>

          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">Tipo de Clase:</label>
                <select class="form-select" 
                        formControlName="class_type_id" 
                        (change)="onClassTypeChange()">
                  <option value="">Seleccionar tipo...</option>
                  <option *ngFor="let type of classTypes" [value]="type.id">
                    {{ type.name }}
                  </option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Capacidad:</label>
                <div class="form-control-plaintext capacity-display">
                  <span *ngIf="sessionForm.get('class_type_id')?.value" class="badge bg-primary">
                    {{ getClassTypeCapacity(sessionForm.get('class_type_id')?.value) }} personas
                  </span>
                  <span *ngIf="!sessionForm.get('class_type_id')?.value" class="text-muted">
                    Automática
                  </span>
                </div>
                <!-- Campo oculto para la capacidad -->
                <input type="hidden" formControlName="capacity">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Fecha:</label>
                <input type="date" 
                       class="form-control" 
                       formControlName="schedule_date">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Hora:</label>
                <input type="time" 
                       class="form-control" 
                       formControlName="schedule_time">
              </div>
            </div>
          </div>

          <!-- Selector de usuario para sesiones personalizadas -->
          <div class="row" *ngIf="selectedTypeIsPersonal">
            <div class="col-md-12">
              <div class="mb-3">
                <label class="form-label">Usuario (obligatorio para sesiones personalizadas):</label>
                <select class="form-select" formControlName="user_id">
                  <option value="">Seleccionar usuario...</option>
                  <option *ngFor="let u of availableUsers" [value]="u.id">{{ u.name }} {{ u.surname }} — {{ u.email }}</option>
                </select>
                <div *ngIf="!sessionForm.get('user_id')?.value" class="form-text text-muted small mt-1">
                  Debes seleccionar un usuario para crear una sesión personalizada.
                </div>
              </div>
            </div>
          </div>
          <!-- Inline helper when selected user has no valid package -->
          <div *ngIf="selectedTypeIsPersonal" class="row">
            <div class="col-md-12">
              <div *ngIf="checkingPackageAvailability" class="alert alert-info small">
                Comprobando si el usuario tiene un bono válido...
              </div>
              <div *ngIf="selectedUserHasValidPackage === false || selectedUserHasPackageButNotForMonth" class="alert alert-warning d-flex justify-content-between align-items-center">
                <div>
                  <i class="fas fa-exclamation-circle me-2"></i>
                  <span *ngIf="selectedUserHasValidPackage === false">El usuario seleccionado no tiene un bono válido para esta sesión. Debes añadirle uno antes de crear la sesión.</span>
                  <span *ngIf="selectedUserHasPackageButNotForMonth">El usuario tiene un bono, pero no coincide con el mes de esta sesión. Puedes añadirle un bono válido para este mes antes de crear la sesión.</span>
                </div>
                <div>
                  <button class="btn btn-sm btn-primary" type="button" (click)="openAddPackageModal(getSelectedUser(), getClassTypeName(sessionForm.get('class_type_id')?.value))">Añadir bono</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Recurring options -->
          <div class="mb-3" *ngIf="!isEditing">
            <div class="form-check">
              <input class="form-check-input" 
                     type="checkbox" 
                     formControlName="recurring" 
                     id="recurring"
                     (change)="onRecurringChange()">
              <label class="form-check-label" for="recurring">
                <strong>Sesión recurrente</strong>
                <small class="text-muted d-block">Crear múltiples sesiones automáticamente</small>
              </label>
            </div>
          </div>

          <!-- Recurring configuration -->
          <div *ngIf="!isEditing && sessionForm.get('recurring')?.value" class="recurring-config">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Frecuencia:</label>
                  <select class="form-select" 
                          formControlName="recurring_type"
                          (change)="onRecurringChange()">
                    <option value="">Seleccionar frecuencia...</option>
                    <option value="daily">Diariamente</option>
                    <option value="weekly">Semanalmente</option>
                    <option value="biweekly">Cada 2 semanas</option>
                    <option value="monthly">Mensualmente</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Fecha de fin:</label>
                  <input type="date" 
                         class="form-control" 
                         formControlName="recurring_end_date"
                         [min]="sessionForm.get('schedule_date')?.value">
                </div>
              </div>
            </div>

            <!-- Preview de sesiones recurrentes -->
            <div class="alert alert-info mb-3" *ngIf="getRecurringPreview()">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Vista previa:</strong> {{ getRecurringPreview() }}
            </div>
          </div>

          <!-- Error messages -->
          <div *ngIf="error" class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ error }}
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">
            Cancelar
          </button>
          
          <button *ngIf="isEditing" 
                  type="button" 
                  class="btn btn-danger me-2" 
                  (click)="deleteSession()"
                  [disabled]="loading">
            <i class="fas fa-trash me-1"></i>
            Eliminar
          </button>
          
    <button type="submit" 
      class="btn btn-primary" 
      [disabled]="sessionForm.invalid || loading || (selectedTypeIsPersonal && (!sessionForm.get('user_id')?.value || selectedUserHasValidPackage !== true))">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            <i *ngIf="!loading && !isEditing" class="fas fa-plus me-1"></i>
            <i *ngIf="!loading && isEditing" class="fas fa-save me-1"></i>
            {{ isEditing ? 'Guardar Cambios' : 'Crear Sesión' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop fade show" *ngIf="showModal"></div>

<!-- Floating bulk progress (non-blocking) -->
<div *ngIf="bulkActive" class="bulk-progress-container">
  <div class="bulk-progress-card">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <strong>Creando sesiones...</strong>
      <button type="button" class="btn-close" (click)="dismissBulkProgress()" title="Ocultar"></button>
    </div>
    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" [attr.aria-valuenow]="bulkPercent">
      <div class="progress-bar progress-bar-striped progress-bar-animated" [style.width.%]="bulkPercent">
        {{ bulkPercent }}%
      </div>
    </div>
    <div class="d-flex justify-content-between mt-2 small text-muted">
      <span>{{ bulkDone }}/{{ bulkTotal }} creadas</span>
      <span *ngIf="bulkErrors > 0" class="text-danger">{{ bulkErrors }} errores</span>
    </div>
  </div>
  <div class="bulk-progress-hint">Puedes seguir navegando y creando cosas mientras tanto.</div>
  <div class="bulk-progress-actions">
    <button class="btn btn-sm btn-outline-light" (click)="refetchCalendarSafely()">Refrescar ahora</button>
  </div>
  <div class="bulk-progress-spinner">
    <div class="spinner-border spinner-border-sm text-light" role="status"></div>
  </div>
  <i class="fa fa-calendar-plus bulk-progress-icon"></i>
  <div class="bulk-progress-percent">{{ bulkPercent }}%</div>
  <div class="bulk-progress-count">{{ bulkDone }}/{{ bulkTotal }}</div>
</div>

<!-- Modal de Gestión de Asistentes -->
<div class="modal fade" 
     [class.show]="showAttendeesModal" 
     [style.display]="showAttendeesModal ? 'block' : 'none'" 
     *ngIf="showAttendeesModal"
     tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      
      <!-- Header del Modal -->
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-users me-2"></i>
          Gestionar Asistentes - {{ selectedSession?.class_type_name }}
        </h5>
        <button type="button" 
                class="btn-close" 
                (click)="closeAttendeesModal()"
                [disabled]="attendeesLoading">
        </button>
      </div>

      <!-- Body del Modal -->
      <div class="modal-body">
        <!-- Loading State -->
  <div *ngIf="attendeesLoading" class="text-center py-4">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mb-0">Cargando asistentes...</p>
        </div>

        <!-- Content cuando no está cargando -->
  <div *ngIf="!attendeesLoading">
          
          <!-- Información de la clase -->
          <div class="class-details mb-4" *ngIf="selectedSession">
            <div class="card bg-light">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <strong>Fecha:</strong><br>
                    <span>{{ selectedSession.schedule_date | date:'dd/MM/yyyy' }}</span>
                    <br>
                    <strong>Hora:</strong><br>
                    <span>{{ formatTimeForTemplate(selectedSession.schedule_time) | date:'HH:mm' }}</span>
                  </div>
                  <div class="col-md-3">
                    <strong>Capacidad:</strong><br>
                    <span>{{ sessionAttendees.length }}/{{ selectedSession.capacity }}</span>
                  </div>
                  <div class="col-md-3">
                    <strong>Espacios:</strong><br>
                    <span class="badge" 
                          [class.bg-success]="sessionAttendees.length < selectedSession.capacity"
                          [class.bg-warning]="sessionAttendees.length >= selectedSession.capacity">
                      {{ selectedSession.capacity - sessionAttendees.length }} libres
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mensajes de Error -->
          <div *ngIf="error" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ error }}
          </div>

          <!-- Mensajes de Éxito -->
          <div *ngIf="successMessage" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            {{ successMessage }}
          </div>

          <!-- Lista de Asistentes Actuales -->
          <div class="attendees-section mb-4">
            <h6 class="mb-3">
              <i class="fas fa-user-check me-2"></i>
              Asistentes Confirmados ({{ sessionAttendees.length }})
            </h6>
            
            <div *ngIf="sessionAttendees.length === 0" class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              No hay asistentes confirmados para esta clase.
            </div>

            <div *ngIf="sessionAttendees.length > 0" class="attendees-list">
              <div *ngFor="let booking of sessionAttendees" 
                   class="attendee-item d-flex justify-content-between align-items-center mb-2 p-3 border rounded bg-white">
                <div class="attendee-info">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-user-circle me-2 text-primary"></i>
                    <div>
                      <strong class="text-dark">
                        {{ (booking.users?.name || booking.user?.name || 'Usuario') }} 
                        {{ (booking.users?.surname || booking.user?.surname || '') }}
                      </strong>
                    </div>
                  </div>
                </div>
                <button class="btn btn-danger btn-sm" 
                        (click)="removeAttendee(booking)"
                        [disabled]="attendeesLoading"
                        title="Eliminar asistente">
                  <i class="fas fa-times me-1"></i>
                  Eliminar
                </button>
              </div>
            </div>
          </div>

          <!-- Sección para Añadir Usuarios -->
          <div class="add-user-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">
                <i class="fas fa-user-plus me-2"></i>
                Añadir Asistente
              </h6>
              <button class="btn btn-outline-primary btn-sm" 
                      (click)="toggleAddUserSection()"
                      [disabled]="attendeesLoading || sessionAttendees.length >= selectedSession?.capacity!">
                <i class="fas fa-plus me-1"></i>
                {{ showAddUserSection ? 'Cancelar' : 'Añadir Usuario' }}
              </button>
            </div>

            <!-- Formulario de búsqueda y selección -->
            <div *ngIf="showAddUserSection" class="add-user-form">
              <div class="search-section mb-3">
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="text" 
                         class="form-control" 
                         placeholder="Buscar usuario por nombre o email..."
                         [(ngModel)]="searchTerm">
                </div>
              </div>

              <!-- Lista de usuarios disponibles -->
              <div class="available-users">
                <div *ngIf="availableUsers.length === 0 && searchTerm" 
                     class="alert alert-warning">
                  <i class="fas fa-search me-2"></i>
                  No se encontraron usuarios que coincidan con "{{ searchTerm }}"
                </div>

                <div *ngIf="availableUsers.length === 0 && !searchTerm" 
                     class="alert alert-info">
                  <i class="fas fa-users me-2"></i>
                  Todos los usuarios ya están asignados a esta clase.
                </div>

                <div class="user-list" style="max-height: 200px; overflow-y: auto;">
                  <div *ngFor="let user of availableUsers.slice(0, 10)" 
                       class="user-item p-3 border rounded bg-light mb-2 cursor-pointer user-card-hover"
                       (click)="addAttendee(user)"
                       [class.disabled]="loading"
                       title="Clic para añadir a la clase">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="user-info flex-grow-1">
                        <div class="d-flex align-items-center">
                          <i class="fas fa-user-plus me-2 text-success"></i>
                          <div>
                            <strong class="text-dark">{{ user.name }} {{ user.surname }}</strong>
                            <br>
                            <small class="text-muted">{{ user.email }}</small>
                          </div>
                        </div>
                      </div>
                      <div class="add-indicator">
                        <i class="fas fa-plus-circle text-success fs-5"></i>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="availableUsers.length > 10" class="text-muted text-center mt-2">
                  <small>Mostrando 10 de {{ availableUsers.length }} usuarios. Usa la búsqueda para refinar.</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer del Modal -->
      <div class="modal-footer" *ngIf="!loading">
        <button type="button" 
                class="btn btn-secondary" 
                (click)="closeAttendeesModal()">
          <i class="fas fa-times me-2"></i>
          Cerrar
        </button>
        
        <button type="button" 
                class="btn btn-primary" 
                (click)="openEditModal(selectedSession!)"
                *ngIf="selectedSession">
          <i class="fas fa-cog me-2"></i>
          Configurar Sesión
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal backdrop para asistentes -->
<div class="modal-backdrop fade show" *ngIf="showAttendeesModal"></div>

<!-- Modal de Añadir Bono -->
<div class="modal fade show" 
     *ngIf="showAddPackageModal" 
     style="display: block; background-color: rgba(0,0,0,0.6); z-index: 1060;">
  <div class="modal-dialog modal-md">
    <div class="modal-content package-modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-gift me-2"></i>
          Añadir Bono a {{ selectedUserForPackage?.name }}
        </h5>
        <button type="button" class="btn-close" (click)="closeAddPackageModal()"></button>
      </div>
      
      <div class="modal-body">
        <!-- Información del usuario -->
        <div class="user-info-card mb-3" *ngIf="selectedUserForPackage">
          <div class="d-flex align-items-center">
            <div class="user-avatar me-3">
              {{ selectedUserForPackage.name?.charAt(0).toUpperCase() }}
            </div>
            <div>
              <h6 class="mb-1">{{ selectedUserForPackage.name }}</h6>
              <small class="text-muted">{{ selectedUserForPackage.email }}</small>
            </div>
          </div>
        </div>

        <!-- Formulario de bono -->
        <form [formGroup]="packageForm" (ngSubmit)="addPackageToUser()">
          <!-- Selección del bono -->
          <div class="mb-3">
            <label for="package_id" class="form-label">
              <i class="fa fa-box me-2"></i>Seleccionar Bono
            </label>
            <ng-container *ngIf="!packagePreselected; else preselectedPkg">
              <select id="package_id" class="form-select" formControlName="package_id" required>
                <option value="">Selecciona un bono...</option>
                <option 
                  *ngFor="let pkg of getPackagesByClassType(getClassTypeName(selectedSession?.class_type_id || 0))" 
                  [value]="pkg.id">
                  {{ pkg.name }} 
                  <span *ngIf="pkg.class_count">- {{ pkg.class_count }} clases</span>
                  <span *ngIf="pkg.price"> - €{{ pkg.price }}</span>
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="packageForm.get('package_id')?.invalid && packageForm.get('package_id')?.touched">
                Por favor selecciona un bono.
              </div>
            </ng-container>
            <ng-template #preselectedPkg>
              <div class="card p-3 bg-white border">
                <strong>Se ha seleccionado automáticamente el bono recomendado.</strong>
                <div class="mt-2 small text-muted">
                  {{ getPreselectedPackageName() }}
                </div>
              </div>
            </ng-template>
          </div>

          <!-- Fecha de caducidad -->
          <div class="mb-3">
            <label for="expiration_date" class="form-label">
              <i class="fa fa-calendar me-2"></i>Fecha de Caducidad
            </label>
            <input 
              type="date" 
              id="expiration_date" 
              class="form-control" 
              formControlName="expiration_date">
            <small class="form-text text-muted">
              La activación es inmediata. Selecciona la fecha de caducidad. Por defecto, se propone el último día del próximo mes.
            </small>
          </div>

          <!-- Información del bono seleccionado -->
          <div class="package-info-card" *ngIf="packageForm.get('package_id')?.value">
            <ng-container *ngFor="let pkg of packagesDisponibles">
              <div *ngIf="pkg.id === packageForm.get('package_id')?.value" class="selected-package-info">
                <h6><i class="fa fa-info-circle me-2"></i>Información del Bono</h6>
                <ul class="list-unstyled mb-0">
                  <li><strong>Nombre:</strong> {{ pkg.name }}</li>
                  <li *ngIf="pkg.class_type"><strong>Tipo de clase:</strong> {{ getClassTypeName(pkg.class_type) }}</li>
                </ul>
              </div>
            </ng-container>
          </div>

          <!-- Mensajes -->
          <div class="alert alert-success" *ngIf="successMessage">
            <i class="fa fa-check-circle me-2"></i>{{ successMessage }}
          </div>
          
          <div class="alert alert-danger" *ngIf="error">
            <i class="fa fa-exclamation-circle me-2"></i>{{ error }}
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddPackageModal()">
          <i class="fa fa-times me-2"></i>Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="addPackageToUser()"
          [disabled]="packageForm.invalid || loading">
          <i class="fa fa-spinner fa-spin me-2" *ngIf="loading"></i>
          <i class="fa fa-plus me-2" *ngIf="!loading"></i>
          {{ loading ? 'Añadiendo...' : 'Añadir Bono' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<style>
  .floating-create-session {
    position: fixed;
    right: 24px;
    bottom: 24px;
    z-index: 1050;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    border-radius: 50px;
    padding: 0.75em 1.5em;
    font-size: 1.1em;
    display: flex;
    align-items: center;
    gap: 0.5em;
    transition: box-shadow 0.2s;
  }
  .floating-create-session i {
    font-size: 1.5em;
    margin-right: 0;
  }
  @media (max-width: 767.98px) {
    .floating-create-session {
      padding: 0.75em 1em;
      font-size: 1.3em;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      justify-content: center;
    }
    .floating-create-session span {
      display: none !important;
    }
    .floating-create-session i {
      margin-right: 0;
      font-size: 2em;
    }
  }
</style>
<div class="toast-container" [class.show]="showToast">
  <div class="toast" [class.toast-success]="toastType === 'success'" [class.toast-error]="toastType === 'error'">
    <div class="toast-content">
      <i class="fas fa-check-circle" *ngIf="toastType === 'success'"></i>
      <i class="fas fa-exclamation-triangle" *ngIf="toastType === 'error'"></i>
      <span>{{ toastMessage }}</span>
    </div>
    <button class="toast-close" (click)="hideToast()">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>
